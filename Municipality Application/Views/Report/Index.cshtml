@{
    ViewData["Title"] = "Report Issue - MunicipalConnect";
}

@section Scripts
{
    <script src="~/js/report-form.js"></script>
}

<div class="container mt-4">
    <h1 class="mb-4">Report an Issue</h1>
    <div class="row">
        <div class="col-md-8">
            <form asp-action="Create" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="Address" class="form-label"><i class="bi bi-geo-alt"></i> Location</label>
                    <input type="text" class="form-control" id="Address" name="Address" placeholder="Enter street address, landmark, or area description" required>
                </div>

                @if (string.IsNullOrEmpty(ViewBag.GoogleMapsApiKey as string))
                {
                    <div class="alert alert-warning">
                        Location autocomplete is currently unavailable. Please enter your address manually.
                    </div>
                }

                <!-- Hidden latitude and longitude fields for Google Maps API -->
                <input type="hidden" id="Latitude" name="Latitude" />
                <input type="hidden" id="Longitude" name="Longitude"/>

                <div class="mb-3">
                    <label for="CategoryId" class="form-label"><i class="bi bi-list"></i> Issue Category</label>
                    <select class="form-select" id="CategoryId" name="CategoryId" required>
                        <option value="" selected disabled>Select a category</option>
                        @if (ViewBag.Categories != null)
                        {
                            foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        }
                        else
                        {
                            <option disabled>No categories available</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label for="Description" class="form-label"><i class="bi bi-file-text"></i> Issue Description</label>
                    <textarea class="form-control" id="Description" name="Description" rows="4" placeholder="Please provide detailed information about the issue..." required></textarea>
                </div>

                <div class="mb-3">
                    <p class="mb-2">Would you like to be notified of updates on this report?</p>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="emailCheck" name="emailCheck">
                        <label class="form-check-label" for="emailCheck">Notify me by email</label>
                    </div>

                    <div id="emailField" style="display: none;">
                        <div class="mb-3">
                            <label for="email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email address">
                        </div>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="phoneCheck" name="phoneCheck">
                        <label class="form-check-label" for="phoneCheck">Notify me by phone</label>
                    </div>
                </div>

                <div id="phoneField" style="display: none;">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label"><i class="bi bi-telephone"></i> Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="Enter your phone number">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="files" class="form-label"><i class="bi bi-paperclip"></i> Attach Files (Optional)</label>
                    <div class="border rounded p-3 text-center" id="dropzone" style="height: 140px; margin: auto;">
                        <input type="file" id="files" name="files" multiple class="d-none">
                        <i class="bi bi-cloud-upload fs-1 mb-2"></i>
                        <p class="mb-0">Click to upload or drag and drop</p>
                        <small class="text-muted">Photos, documents (Max 5MB each)</small>
                    </div>
                    <div id="file-list" class="mt-2" style="min-height: 120px; max-height: 160px"></div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" style="height: 56px"><i class="bi bi-send"></i> Submit Issue Report</button>
                </div>
            </form>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-info-circle"></i> Reporting Tips</h5>
                    <ul class="list-unstyled">
                        <li><small>• Be as specific as possible with location details</small></li>
                        <li><small>• Include photos when possible for faster resolution</small></li>
                        <li><small>• You'll receive updates via email or SMS about your report status</small></li>
                        <li><small>• Emergency issues should be reported by calling 10111</small></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (!string.IsNullOrEmpty(ViewBag.GoogleMapsApiKey as string))
    {
        <script src="https://maps.googleapis.com/maps/api/js?key=@ViewBag.GoogleMapsApiKey&libraries=places"></script>
        <script>
            // Initialize Google Places Autocomplete for the Address input field
            document.addEventListener('DOMContentLoaded', function () {
                var input = document.getElementById('Address');
                var latitudeInput = document.getElementById('Latitude');
                var longitudeInput = document.getElementById('Longitude');
                if (input && window.google && google.maps && google.maps.places) {
                    var autocomplete = new google.maps.places.Autocomplete(input, {
                        types: ['geocode'],
                        componentRestrictions: { country: 'za' } // Restrict to South Africa
                    });
                    autocomplete.addListener('place_changed', function () {
                        var place = autocomplete.getPlace();
                        if (place.geometry) {
                            latitudeInput.value = place.geometry.location.lat();
                            longitudeInput.value = place.geometry.location.lng();
                        }
                    });
                }
            });
        </script>
    }
}