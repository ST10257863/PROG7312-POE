@{
    ViewData["Title"] = "Report Issue - MunicipalConnect";
}

<div class="container mt-4">
    <h1 class="mb-4">Report an Issue</h1>
    <div class="row">
        <div class="col-md-8">
            <form asp-action="ReportIssue" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="location" class="form-label"><i class="bi bi-geo-alt"></i> Location</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="Enter street address, landmark, or area description" required>
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label"><i class="bi bi-list"></i> Issue Category</label>
                    <select class="form-select" id="category" name="category" required>
                        <option value="" selected disabled>Select a category</option>
                        <option value="roads">Roads</option>
                        <option value="water">Water</option>
                        <option value="electricity">Electricity</option>
                        <option value="sanitation">Sanitation</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label"><i class="bi bi-file-text"></i> Issue Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="Please provide detailed information about the issue, including when you first noticed it, how it affects you or the community, and any other relevant details..." required></textarea>
                </div>

                <div class="mb-3">
                    <p class="mb-2">Would you like to be notified of updates on this report?</p>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="emailCheck" name="emailCheck">
                        <label class="form-check-label" for="emailCheck">Notify me by email</label>
                    </div>

                    <div id="emailField" style="display: none;">
                        <div class="mb-3">
                            <label for="email" class="form-label"><i class="bi bi-envelope"></i> Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email address">
                        </div>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="phoneCheck" name="phoneCheck">
                        <label class="form-check-label" for="phoneCheck">Notify me by phone</label>
                    </div>
                </div>

                <div id="phoneField" style="display: none;">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label"><i class="bi bi-telephone"></i> Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="Enter your phone number">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="files" class="form-label"><i class="bi bi-paperclip"></i> Attach Files (Optional)</label>
                    <div class="border rounded p-3 text-center" id="dropzone" style="height: 140px; margin: auto;">
                        <input type="file" id="files" name="files" multiple class="d-none">
                        <i class="bi bi-cloud-upload fs-1 mb-2"></i>
                        <p class="mb-0">Click to upload or drag and drop</p>
                        <small class="text-muted">Photos, documents (Max 5MB each)</small>
                    </div>
                    <div id="file-list" class="mt-2" style="min-height: 120px; max-height: 160px"></div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i> Submit Issue Report</button>
                </div>
            </form>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-info-circle"></i> Reporting Tips</h5>
                    <ul class="list-unstyled">
                        <li><small>• Be as specific as possible with location details</small></li>
                        <li><small>• Include photos when possible for faster resolution</small></li>
                        <li><small>• You'll receive updates via email about your report status</small></li>
                        <li><small>• Emergency issues should be reported by calling 10111</small></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('files');
        const fileList = document.getElementById('file-list');

        dropzone.addEventListener('click', () => fileInput.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropzone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            let files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            Array.from(files).forEach((file, index) => {
                if (!fileAlreadyAdded(file)) {
                    let fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
                    let fileItem = document.createElement('div');
                    fileItem.className = 'd-flex justify-content-between align-items-center mb-1';
                    fileItem.innerHTML = `
                        <span><i class="bi bi-file-earmark"></i> ${file.name} (${fileSize} MB)</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${file.name}')">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                }
            });
        }

        function fileAlreadyAdded(file) {
            return Array.from(fileList.children).some(item => item.textContent.includes(file.name));
        }

        function removeFile(fileName) {
            let newFileList = Array.from(fileInput.files).filter(file => file.name !== fileName);
            updateFileList(newFileList);

            // Remove the file item from the display
            let fileItems = fileList.children;
            for (let i = 0; i < fileItems.length; i++) {
                if (fileItems[i].textContent.includes(fileName)) {
                    fileItems[i].remove();
                    break;
                }
            }
        }

        function updateFileList(newFileList) {
            let dataTransfer = new DataTransfer();
            newFileList.forEach(file => {
                dataTransfer.items.add(file);
            });
            fileInput.files = dataTransfer.files;
        }

        const emailCheck = document.getElementById('emailCheck');
        const phoneCheck = document.getElementById('phoneCheck');
        const emailField = document.getElementById('emailField');
        const phoneField = document.getElementById('phoneField');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phoneNumber');
        const form = document.querySelector('form');

        emailCheck.addEventListener('change', function() {
            emailField.style.display = this.checked ? 'block' : 'none';
            emailInput.required = this.checked;
        });

        phoneCheck.addEventListener('change', function() {
            phoneField.style.display = this.checked ? 'block' : 'none';
            phoneInput.required = this.checked;
        });

        form.addEventListener('submit', function(e) {
            if (emailCheck.checked && emailInput.value.trim() === '') {
                e.preventDefault();
                alert('Please enter your email address for notifications.');
            }
            if (phoneCheck.checked && phoneInput.value.trim() === '') {
                e.preventDefault();
                alert('Please enter your phone number for notifications.');
            }
        });
    </script>
}